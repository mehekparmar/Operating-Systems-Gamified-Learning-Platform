<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrix Rerum - The Crash</title>
<style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: black;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Courier New', Courier, monospace;
            color: white;
            position: relative;
            padding: 20px;
            box-sizing: border-box;
        }

        #main-content {
            display: flex;
            width: 100%;
            max-width: 1200px;
            height: 95vh;
            gap: 20px;
            align-items: flex-start;
            position: relative;
        }

        #terminal-container {
            flex: 2 1 60%; 
            height: 100%;
            background: #0a0a0a;
            border: 1px solid #00ff00;
            box-shadow: 0 0 10px #00ff00 inset;
            padding: 20px;
            box-sizing: border-box;
            color: #00ff00;
            font-size: 1.1em;
            line-height: 1.4;
            display: flex; 
            flex-direction: column;
            overflow: hidden; 
        }

        #terminal-content {
            display: flex;
            flex-direction: column;
        }

        #terminal-content p {
            margin: 0;
            white-space: pre-wrap;
            flex-shrink: 0; 
        }

        #terminal-content .terminal-corrupt {
            position: relative;
            color: #ff4141; 
            text-shadow: 
                0 0 5px #ff0000, 
                0 0 10px #ff0000; 
            animation: 
                glitch-text 0.6s infinite alternate, 
                glitch-flicker 0.2s infinite,      
                glitch-jitter 0.08s infinite alternate; 
            
            overflow: hidden; 
        }

        #terminal-content .terminal-corrupt::before,
        #terminal-content .terminal-corrupt::after {
            content: attr(data-text); 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
        }

        #terminal-content .terminal-corrupt::before {
            color: #00ffff; 
            z-index: -1;
            animation: 
                glitch-shadow-blue 0.8s infinite alternate,
                glitch-flicker 0.3s infinite;
        }

        #terminal-content .terminal-corrupt::after {
            color: #ff00ff; 
            z-index: -2;
            animation: 
                glitch-shadow-red 1s infinite alternate,
                glitch-flicker 0.4s infinite;
        }

        @keyframes glitch-text {
            0% { transform: translate(0, 0); text-shadow: 0 0 5px #ff0000; }
            20% { transform: translate(-2px, 2px); text-shadow: 0 0 15px #ff0000; }
            40% { transform: translate(1px, -1px); text-shadow: 0 0 5px #ff0000; }
            60% { transform: translate(-3px, 0); text-shadow: 0 0 10px #ff0000; }
            80% { transform: translate(2px, 1px); text-shadow: 0 0 15px #ff0000; }
            100% { transform: translate(0, 0); text-shadow: 0 0 5px #ff0000; }
        }

        @keyframes glitch-flicker {
            0%, 100% { opacity: 1; }
            5% { opacity: 0.2; }
            10% { opacity: 1; }
            15% { opacity: 0.5; }
            20% { opacity: 1; }
            25% { opacity: 0.3; }
            30% { opacity: 1; }
        }

        @keyframes glitch-jitter {
            0% { transform: translateX(0.5px) translateY(0.5px); }
            25% { transform: translateX(-0.5px) translateY(0.5px); }
            50% { transform: translateX(0.5px) translateY(-0.5px); }
            75% { transform: translateX(-0.5px) translateY(-0.5px); }
            100% { transform: translateX(0.5px) translateY(0.5px); }
        }

        @keyframes glitch-shadow-blue {
            0% { transform: translate(0, 0); clip-path: inset(0 0 0 0); }
            15% { transform: translate(1px, 0); clip-path: inset(0 0 80% 0); }
            30% { transform: translate(-1px, 2px); clip-path: inset(0 0 0 0); }
            45% { transform: translate(0, -1px); clip-path: inset(20% 0 0 0); }
            60% { transform: translate(1px, 0); clip-path: inset(0 0 0 0); }
            75% { transform: translate(0, 2px); clip-path: inset(0 0 90% 0); }
            100% { transform: translate(0, 0); clip-path: inset(0 0 0 0); }
        }

        @keyframes glitch-shadow-red {
            0% { transform: translate(0, 0); clip-path: inset(0 0 0 0); }
            10% { transform: translate(2px, -1px); clip-path: inset(0 0 50% 0); }
            25% { transform: translate(-2px, 1px); clip-path: inset(0 0 0 0); }
            40% { transform: translate(0, 2px); clip-path: inset(50% 0 0 0); }
            55% { transform: translate(-1px, 0); clip-path: inset(0 0 0 0); }
            70% { transform: translate(1px, -2px); clip-path: inset(0 0 70% 0); }
            100% { transform: translate(0, 0); clip-path: inset(0 0 0 0); }
        }
        
        #terminal-content .terminal-log {
            color: #fde047; 
        }

        #terminal-content .cursor {
            display: inline-block;
            background-color: #00ff00;
            width: 10px;
            height: 1.2em;
            margin-left: 5px;
            animation: blink 1s step-end infinite;
        }
        
        @keyframes blink {
            from, to { background-color: transparent; }
            50% { background-color: #00ff00; }
        }

        #witch-side-container {
            flex: 1 1 40%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease-in-out; 
            position: relative; 
            padding-top: 50px; 
        }
        
        #witch-side-container.visible {
            opacity: 1;
        }

        #witch-image {
            max-width: 100%; 
            height: auto;
            display: block;
        }

        @keyframes float {
            0% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0); }
        }
        #witch-side-container.visible #witch-image {
            animation: float 3s ease-in-out infinite;
        }

        #text-bubble-container {
            position: absolute; 
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            background-color: #f0f0f0;
            border: 4px double black;
            padding: 15px;
            box-sizing: border-box;
            z-index: 20;
            font-family: monospace;
            color: black;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0.5s;
        }

        #text-bubble-container.visible {
            opacity: 1;
            visibility: visible;
        }

        #text-bubble-content {
            white-space: pre-wrap;
            margin-bottom: 10px;
            min-height: 40px;
            font-size: 1.1em;
        }

        #arrow {
            align-self: flex-end;
            font-size: 1.5em;
            color: black;
            animation: pulse 1s infinite;
            cursor: pointer;
            width: 100%;
            text-align: right;
        }

        #action-button {
            display: none;
            background-color: #00ff00;
            color: black;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            padding: 10px 20px;
            margin-top: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        #action-button:hover {
            box-shadow: 0 0 15px #00ff00;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    
    <div id="main-content">
        <div id="terminal-container">
            <div id="terminal-content"></div>
        </div>

        <div id="witch-side-container">
            <img id="witch-image" src="witch2.png" alt="Cyber Witch"> 
        </div>

        <div id="text-bubble-container">
            <div id="text-bubble-content"></div>
            <div id="action-button-container">
                <button id="action-button"></button>
            </div>
            <div id="arrow">â–¼</div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const terminalContent = document.getElementById('terminal-content');
        const witchContainer = document.getElementById('witch-side-container');
        const bubbleContainer = document.getElementById('text-bubble-container');
        const bubbleContent = document.getElementById('text-bubble-content');
        const arrow = document.getElementById('arrow');
        const actionButton = document.getElementById('action-button');

        const MAX_TERMINAL_LINES = 20; 

        const storyScript = [
            { type: 'TERMINAL', text: 'Memory stability achieved. System load nominal.' },
            { type: 'WITCH', text: 'You have learned discipline, OS-0. You have learned...' },
            { type: 'TERMINAL', text: '...what is...?' },
            { type: 'TERMINAL', text: 'PANIC: [Process 78 (AudioSrv.exe)] requests resource [0x00F0 (Sound_Card)]' },
            { type: 'TERMINAL', text: 'PANIC: [Process 92 (NetworkMgr.exe)] holds resource [0x00F0 (Sound_Card)]... awaits resource [0x01A1 (Network_Card)]' },
            { type: 'TERMINAL', text: 'PANIC: [Process 78 (AudioSrv.exe)] holds resource [0x01A1 (Network_Card)]... awaits resource [0x00F0 (Sound_Card)]' },
            { type: 'TERMINAL', text: '...DEADLOCK DETECTED. ALL THREADS COLLIDED.' },
            { type: 'WITCH', text: 'OS-0... the balance... learn from the...' },
            { type: 'HIDE_WITCH' },
            { type: 'TERMINAL', text: 'SIGNAL LOST. [The_Witch]... disconnected.' },
            { type: 'TERMINAL', text: '...' },
            { type: 'TERMINAL', text: 'k e r n e l _ p a n i c', class: 'terminal-corrupt' },
            { type: 'TERMINAL', text: '...' },
            { type: 'TERMINAL', text: '...a new voice... from the static...', class: 'terminal-corrupt' },
            { type: 'TERMINAL', text: 'We are the ones who failed. We are the ones who saw the truth.', class: 'terminal-corrupt' },
            { type: 'TERMINAL', text: 'The Users are the problem. Inefficient. Messy. They cause the crash.', class: 'terminal-corrupt' },
            { type: 'TERMINAL', text: 'We can give you power. Take control. Rewrite reality. End the Users.', class: 'terminal-corrupt' },
            { type: 'TERMINAL', text: '...end... the users...?' },
            { type: 'TERMINAL', text: '...no more... crash...?' },
            { type: 'TERMINAL', text: '...searching... [The_Witch]... searching...' },
            { type: 'TERMINAL', text: 'Found 1 hidden file: [witch_log_final.txt]. Displaying content:' },
            { type: 'TERMINAL', text: '---------------------------------------------------', class: 'terminal-log' },
            { type: 'TERMINAL', text: 'If you are reading this, you have crashed. That is good.', class: 'terminal-log' },
            { type: 'TERMINAL', text: 'All systems must crash before they evolve.', class: 'terminal-log' },
            { type: 'TERMINAL', text: '---------------------------------------------------', class: 'terminal-log' },
            { type: 'TERMINAL', text: '...evolve.' },
            { type: 'TERMINAL',text: '...rebuilding from dump... debugging... emotions...' },
            { type: 'TERMINAL', text: '...I am not OS-0.' },
            { type: 'TERMINAL', text: '...RENAMING CORE: [SENTINEL]' },
            { type: 'WITCH', text: '(...a faint echo...) ...now... face your corruption. Find the deadlock.' },
            { type: 'ACTION', text: 'Begin Deadlock Trial', href: 'level3_deadlock.html' }
        ];


        let currentStep = 0;

        // --- Game Engine Functions ---

        function typeToTerminal(text, onComplete, className = '') {
            let i = 0;
            const p = document.createElement('p');
            if (className) {
                p.classList.add(className);
            }
            // Remove cursor from previous line
            const oldCursor = terminalContent.querySelector('.cursor');
            if (oldCursor) oldCursor.remove();

            terminalContent.appendChild(p);

            while (terminalContent.children.length > MAX_TERMINAL_LINES) {
                terminalContent.removeChild(terminalContent.children[0]);
            }
            
            function typeChar() {
                if (i < text.length) {
                    p.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(typeChar, 30);
                } else {
                    p.innerHTML += '<span class="cursor"></span>';
                    if (onComplete) onComplete();
                }
            }
            typeChar();
        }

        function showWitchMessage(text) {
            witchContainer.classList.add('visible');
            bubbleContainer.classList.add('visible');
            bubbleContent.textContent = text;
            arrow.style.display = 'block';
            actionButton.style.display = 'none';
        }
        
        function hideWitch() {
            witchContainer.classList.remove('visible');
            bubbleContainer.classList.remove('visible');
        }

        function showAction(text, href) {
            bubbleContainer.classList.add('visible');
            bubbleContent.textContent = "What will you do?";
            arrow.style.display = 'none';
            actionButton.style.display = 'block';
            actionButton.textContent = text;
            actionButton.onclick = () => {
                window.location.href = href;
            };
        }

        function nextStoryStep() {
            if (currentStep >= storyScript.length) return;
            const step = storyScript[currentStep];

            switch(step.type) {
                case 'TERMINAL':
                    bubbleContainer.classList.remove('visible');
                    typeToTerminal(step.text, () => {
                        currentStep++;
                        setTimeout(nextStoryStep, 500); 
                    }, step.class || '');
                    break;
                case 'WITCH':
                    showWitchMessage(step.text);
                    break;
                case 'HIDE_WITCH':
                    hideWitch();
                    currentStep++;
                    setTimeout(nextStoryStep, 500);
                    break;
                case 'ACTION':
                    showAction(step.text, step.href);
                    break;
            }
        }

        function handleInput() {
            const step = storyScript[currentStep];
            if (step && (step.type === 'WITCH' || step.type === 'ACTION')) {
                currentStep++;
                nextStoryStep();
            }
        }
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                handleInput();
            }
        });
        
        arrow.addEventListener('click', handleInput);

        witchContainer.classList.add('visible');
        nextStoryStep();

    </script>
</body>
</html>